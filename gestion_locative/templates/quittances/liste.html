{% extends "base.html" %}

{% block title %}Quittances - Gestion Locative{% endblock %}

{% block content %}
<h1 class="page-title"><i class="bi bi-file-earmark-text"></i> Génération de quittances</h1>

<div class="card">
    <div class="card-header">
        <i class="bi bi-printer"></i> Générer une quittance
    </div>
    <div class="card-body">
        {% if locataires %}
            <form id="quittanceForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="locataire_select" class="form-label">Locataire</label>
                        <select class="form-select" id="locataire_select" required>
                            <option value="">Sélectionner un locataire...</option>
                            {% for loc in locataires %}
                                <option value="{{ loc.id }}">
                                    {{ loc.nom_complet }} - {{ loc.bien.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="mois_select" class="form-label">Mois</label>
                        <input type="month" class="form-control" id="mois_select" required>
                    </div>
                    
                    <div class="col-md-2 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-file-earmark-pdf"></i> Générer
                        </button>
                    </div>
                </div>
            </form>
            
            <hr>
            
            <h5><i class="bi bi-info-circle"></i> Instructions</h5>
            <ul class="text-muted">
                <li>Sélectionnez le locataire et le mois pour lequel vous souhaitez générer une quittance.</li>
                <li>La quittance s'ouvrira dans un nouvel onglet au format imprimable.</li>
                <li>Utilisez <kbd>Ctrl+P</kbd> (ou <kbd>Cmd+P</kbd> sur Mac) pour imprimer ou sauvegarder en PDF.</li>
                <li>La quittance indiquera si le paiement a été reçu ou non pour le mois concerné.</li>
            </ul>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-exclamation-circle display-4 text-warning"></i>
                <h4 class="mt-3">Aucun locataire actif</h4>
                <p class="text-muted">Vous devez d'abord ajouter un locataire pour pouvoir générer des quittances.</p>
                <a href="{{ url_for('ajouter_locataire') }}" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Ajouter un locataire
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Liste des dernières quittances générées -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-clock-history"></i> Accès rapide aux quittances récentes
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Cliquez sur un locataire pour générer la quittance du mois en cours :</p>
        <div class="row">
            {% for loc in locataires %}
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                        <div>
                            <strong>{{ loc.nom_complet }}</strong><br>
                            <small class="text-muted">{{ loc.bien.nom }}</small>
                        </div>
                        <a href="{{ url_for('generer_quittance', locataire_id=loc.id, mois=now) }}" 
                           class="btn btn-outline-primary btn-sm" target="_blank">
                            <i class="bi bi-file-earmark-text"></i> Ce mois
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pré-remplir le mois en cours
    const currentMonth = new Date().toISOString().slice(0, 7);
    document.getElementById('mois_select').value = currentMonth;
    
    // Gestion du formulaire
    document.getElementById('quittanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const locataireId = document.getElementById('locataire_select').value;
        const mois = document.getElementById('mois_select').value;
        
        if (locataireId && mois) {
            window.open(`/quittances/generer/${locataireId}/${mois}`, '_blank');
        }
    });
</script>
{% endblock %}
