{% extends "base.html" %}

{% block title %}Statistiques {{ annee }} - Gestion Locative{% endblock %}

{% block content %}
<h1 class="page-title"><i class="bi bi-bar-chart"></i> Statistiques</h1>

<div class="row">
    <!-- Graphique des revenus -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up"></i> Revenus par bien</span>
                <select id="selectAnnee" class="form-select form-select-sm" style="width: auto;">
                    {% for a in annees_disponibles %}
                        <option value="{{ a }}" {{ 'selected' if a == annee }}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="card-body">
                <canvas id="revenusChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Résumé -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-calculator"></i> Résumé {{ annee }}
            </div>
            <div class="card-body">
                {% set total_annuel = revenus_mensuels|sum(attribute='total') %}
                <div class="text-center mb-4">
                    <h2 class="text-primary">{{ "%.2f"|format(total_annuel) }} &euro;</h2>
                    <p class="text-muted">Total perçu en {{ annee }}</p>
                </div>

                <hr>

                <div class="d-flex justify-content-between mb-2">
                    <span>Moyenne mensuelle :</span>
                    <strong>{{ "%.2f"|format(total_annuel / 12) }} &euro;</strong>
                </div>

                <div class="d-flex justify-content-between mb-2">
                    <span>Nombre de biens :</span>
                    <strong>{{ biens_stats|length }}</strong>
                </div>

                {% set locataires_actifs = biens_stats|selectattr('locataire')|list|length %}
                <div class="d-flex justify-content-between mb-2">
                    <span>Taux d'occupation :</span>
                    <strong>{{ "%.0f"|format((locataires_actifs / biens_stats|length * 100) if biens_stats else 0) }}%</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistiques par bien -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-building"></i> Statistiques par bien
    </div>
    <div class="card-body">
        <div class="row">
            {% for stat in biens_stats %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>
                                {% if stat.bien.type_bien == 'appartement' %}
                                    <i class="bi bi-house-door text-primary"></i>
                                {% else %}
                                    <i class="bi bi-shop text-warning"></i>
                                {% endif %}
                                {{ stat.bien.nom }}
                            </span>
                            {% if stat.locataire %}
                                <span class="badge bg-success">Loué</span>
                            {% else %}
                                <span class="badge bg-secondary">Vacant</span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td>Locataire actuel :</td>
                                    <td><strong>{{ stat.locataire.nom_complet if stat.locataire else 'Aucun' }}</strong></td>
                                </tr>
                                {% if stat.locataire %}
                                <tr>
                                    <td>Loyer mensuel :</td>
                                    <td><strong>{{ stat.locataire.loyer_total }} &euro;</strong></td>
                                </tr>
                                <tr>
                                    <td>Total perçu :</td>
                                    <td><strong class="text-success">{{ "%.2f"|format(stat.total_percu) }} &euro;</strong></td>
                                </tr>
                                {% endif %}
                            </table>

                            {% if stat.locataire %}
                                <div class="progress" style="height: 8px;">
                                    {% set pct = (stat.total_percu / (stat.locataire.loyer_total * 12) * 100) if stat.locataire else 0 %}
                                    <div class="progress-bar bg-success" style="width: {{ pct if pct <= 100 else 100 }}%"></div>
                                </div>
                                <small class="text-muted">{{ "%.0f"|format(pct) }}% du loyer annuel attendu</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Sélecteur d'année → recharge la page
    document.getElementById('selectAnnee').addEventListener('change', function() {
        window.location.href = '{{ url_for("statistiques") }}?annee=' + this.value;
    });

    // Palette de couleurs par bien
    var COULEURS = [
        {bg: 'rgba(155, 89, 182, 0.7)', border: '#9b59b6'},
        {bg: 'rgba(230, 126, 34, 0.7)', border: '#e67e22'},
        {bg: 'rgba(52, 152, 219, 0.7)', border: '#3498db'},
        {bg: 'rgba(46, 204, 113, 0.7)', border: '#2ecc71'},
        {bg: 'rgba(231, 76, 60, 0.7)',  border: '#e74c3c'},
        {bg: 'rgba(241, 196, 15, 0.7)', border: '#f1c40f'}
    ];

    // Labels des mois
    var moisLabels = [{% for l in mois_labels %}'{{ l }}'{% if not loop.last %}, {% endif %}{% endfor %}];
    var moisKeys = [{% for k in mois_keys %}'{{ k }}'{% if not loop.last %}, {% endif %}{% endfor %}];

    // Un dataset par bien
    var datasets = [];
    {% for bien in biens_list %}
    (function() {
        var idx = {{ loop.index0 }} % COULEURS.length;
        var revenusBien = {{ revenus_par_bien[bien.id]['mois'] | tojson }};
        var data = [];
        for (var i = 0; i < moisKeys.length; i++) {
            data.push(revenusBien[moisKeys[i]] || 0);
        }
        datasets.push({
            label: '{{ bien.nom }}',
            data: data,
            backgroundColor: COULEURS[idx].bg,
            borderColor: COULEURS[idx].border,
            borderWidth: 1
        });
    })();
    {% endfor %}

    // Graphique empilé
    var ctx = document.getElementById('revenusChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: moisLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + ' \u20ac';
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
